 CREATE OR REPLACE FUNCTION ff_consultar_fatura_cartao(
  p_empresa_id   BIGINT,
  p_cartao_nome  TEXT,
  p_referencia   DATE DEFAULT CURRENT_DATE
)
RETURNS TABLE (
  mes_referencia DATE,
  status TEXT,
  valor_total NUMERIC
)
LANGUAGE plpgsql
AS $$
BEGIN
  RETURN QUERY
  SELECT
      f.mes_referencia,
      f.status,
      f.valor_total
  FROM cartoes_faturas f
  JOIN cartoes       c ON c.id = f.cartao_id
  JOIN cartoes_transacoes t 
       ON t.fatura_id = f.id
  WHERE f.empresa_id = p_empresa_id
    AND lower(c.nome) = lower(p_cartao_nome)
    AND date_trunc('month', t.data_parcela) = date_trunc('month', p_referencia)
  LIMIT 1;
END;
$$;
